<!DOCTYPE html>

<html>

<head>
	<link rel="stylesheet" type="text/css" href="style/ccStyle_common.css"></link>
	<link rel="stylesheet" type="text/css" href="style/ccStyle_detail.css"></link>

	<title>WebCC; Online Monkey Compiler</title>
</head>

<body>

<div class="wrapper">
	<div id="resources">
		<h2>File System</h2>
		<table id="__monkey_resource_table">
			<tr>
				<th>
					<div class="masked-upload-container mouseClick" title="No file chosen">
	   					<input id="__monkey_dataFiles" type="file" multiple></input>
					</div>
				</th>
				<th>Name</th>
				<th>Type</th>
				<th>Size</th>
			</tr>
			<tr id="__monkey_resource_1">
				<td></td>
				<td>user.monkey</td>
				<td>MONKEY</td>
				<td><center><img class="mouseClick" style="-webkit-filter: contrast(0.8); filter: contrast(0.8);" src="style/images/add_file.png" alt="%r" onclick="simulateEvent(document.getElementById('__monkey_run_cc'), 'click', true, true);"></center></id>
			</tr>
		</table>

		<th><i class="info" title='Add source or asset files with the button on the top-left. (Types limited by configuration)'>?</i></th>
	</div>

	<div id="content">
		<div id="header">
			<p>
				<h2 title="Ported by Anthony Diamond">
					Browser-Based Monkey Compiler; <a class="loud" href="http://regal-internet-brothers.github.io/webcc">WebCC</a>
				</h2>
			</p>
		</div>

		<div id="meta">
			<button id="__monkey_run_cc" onclick="runCompiler();" style="position: relative;" title="Execute">Build and Run</button>
			<input id="__monkey_cc_opts" value='-target=Html5_Game -config=Release -run "data/dev/user.monkey"' title='For a standalone application, try "JavaScript_Tool".'></input>
			<br>
			<input type="checkbox" id="__monkey_releaseFrames" title="Run multiple applications.">Multiple Instances.</input>
		</div>

		<center>
<textarea id="__monkey_main">
Function Main:Int()
	Print("Hello world.")

	Return 0
End
</textarea>

			<p>
				<h3 class="info" title="HTML5 builds have their own consoles; drag it from the bottom to see the output.">
					{ Compiled Source }
				</h3>
			</p>

			<div id="compiled"></div>
		</center>

		<br>

		<div>
			<center>
				<p>
					<h2 title="WebCC output.">
						<< Compiler Output >>
					</h2>
				</p>

				<textarea id="GameConsole" class="debug" readonly></textarea>
			</center>
		</div>
	</div>
</div>

<footer class="site-footer">
	<center>
		<b><h4>MONKEY LICENSE</h4></b>
		<textarea id="__monkey_license" class="small" readonly>Unable to load official Monkey license.</textarea>
		<h4>Ported by <a href="https://twitter.com/immutableoctet">@ImmutableOctet</a> (<a class="silent" href="https://github.com/ImmutableOctet">Anthony Diamond</a>)</h4>
		<h5>{ <a class="silent" href="https://github.com/Regal-Internet-Brothers">Regal Internet Brothers</a> }</h5>
	</center>
</div>

<script language="javascript" src="main.js">Javascript is disabled or unsupported by your browser.</script>
<script language="javascript" src="load.js"></script>

<script type="text/javascript">
	/*
		NOTES:
			* The virtual file "data/dev/user.monkey" is always used as the main module.
			This is currently hard-coded for this front-end. (Not an issue for the backend/compiler)
	*/

	var __monkey_data_files_loaded = 1;

	window.onload = function (e)
	{
		__os_setFileSystemEncoding(FILESYSTEM_ENCODING_STRING);
		
		requestLicense();

		// Create a folder for required uer-data.
		CreateDir("data/dev/user.data");

		// Hooks:
		initFileHook();

		// JS Tool:
		__monkey_jstool_exec();
	}

	function simulateEvent(element, var_args)
	{
		if (element == null)
		{
			return;
		}
		
		var e = document.createEvent('Events');
		
		e.initEvent.apply(e, Array.prototype.slice.call(arguments, 1));
		element.dispatchEvent(e);
	}

	function initFileHook()
	{
		var fileReq = document.getElementById("__monkey_dataFiles");

		fileReq.onchange = function ()
		{
			var monkeyEndSymbol = ".monkey";

			var files = this.files;
			var filesAvailable = files.length;

			for (var i = 0; i < filesAvailable; i++)
			{
				var f = files[i];
				var name = f.name;

				if (name == "user.monkey")
				{
					continue;
				}

				var lCaseFileName = name.toLowerCase();

				var parentDir;

				if (lCaseFileName.lastIndexOf(".monkey") == name.length-monkeyEndSymbol.length) // - 1
				{
					parentDir = "data";
				}
				else
				{
					parentDir = "data/dev/user.data";
				}

				// Asynchronously read the file into the file-system:

				// A slash is added here instead of ahead of time for easy modification if needed.
				var outPath = RealPath(parentDir + "/" + name);

				var reader = new FileReader();

				if (FileType(outPath) != FILETYPE_NONE)
				{
					continue;
				}

				reader.onloadend = function ()
				{
					var result = reader.result;

					if (!result)
					{
						return;
					}

					__monkey_data_files_loaded += 1;

					var max_chars = 24;
					var elementID = ("__monkey_resource_" + __monkey_data_files_loaded);
					var repPath = name;

					var ext = name.substring(name.lastIndexOf(".")+1).toUpperCase(); // ..

					if (ext == null)
					{
						ext = "???"
					}

					var data = __os_ArrayBuffer_To_Native(result);

					__os_createFileEntry(outPath, data, false);

					var table = document.getElementById("__monkey_resource_table");

					if (table != null)
					{
						var row = table.insertRow();

						//.setAttribute("class", "removalElement");
						row.setAttribute("id", elementID);

						row.insertCell().innerHTML = "<img class='removalElement mouseClick' onclick='__monkey_removeFile(\""+elementID+"\");' src='style/images/remove_file.png' alt='{R}'>";
						row.insertCell().innerHTML = repPath;
						row.insertCell().innerHTML = ext;
						row.insertCell().innerHTML = "<center>"+result.byteLength+"</center>";
					}
				}

				/*
					reader.onerror = function()
					{
						// ...
					}
				*/

				reader.readAsArrayBuffer(f);
			}

			this.value = null;
		}
	}

	function requestLicense()
	{
		var here = window.location.pathname;
		var currentPath = here.substring(0, here.lastIndexOf("/"));

		var xhr = new XMLHttpRequest();
		xhr.open("GET", (currentPath + "/data/LICENSE.TXT"));

		xhr.onreadystatechange = function ()
		{
			var data = xhr.responseText;
			var license = document.getElementById("__monkey_license");

			license.value = data;
		}

		xhr.send();
	}

	function runCompiler()
	{
		// Prepare the file:
		var input = document.getElementById("__monkey_main");
		var cc_opts = document.getElementById("__monkey_cc_opts");
		var args = cc_opts.value.split(" ");

		/*
			var args = ['-target=Html5_Game', '-config=Release', '-run', '"'+location+'"'];
			input.value = LoadString("data/hello.monkey"); // LoadString("data/bananas/Richard_Betson/TileImage/TileImage.monkey"); // LoadString("data/bananas/mak/joytest/joytest.monkey"); // LoadString("data/bananas/difference/champagne/champagne.monkey"); // LoadString("data/champagne.monkey"); // "data/test.monkey"
		*/

		var rawFileLocation = args[args.length-1];
		var firstQuote = rawFileLocation.indexOf('"');
		var finalQuote = rawFileLocation.lastIndexOf('"');
		var location = rawFileLocation.substring(firstQuote+1, finalQuote);

		// Create/update our file entry.
		__os_createFileEntry(RealPath(location), __os_String_To_Native(input.value));

		// Build the code.
		executeMonkey(args);  // [] // Html5_Game
	}

	function __monkey_removeFile(id)
	{
		var fileEntry = document.getElementById(id);

		DeleteFile("data/dev/user.data/" + fileEntry.cells[1].innerHTML);

		fileEntry.parentElement.removeChild(fileEntry);
	}
</script>
</body>

</html>
